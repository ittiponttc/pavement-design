import streamlit as st
import numpy as np
import pandas as pd

# ======================================================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
# ======================================================
st.set_page_config(
    page_title="Equivalent Thickness (Odemark)",
    page_icon="üß±",
    layout="wide"
)

st.title("üß± ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ (Equivalent Thickness)")
st.markdown(
"""
‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á  
**Multi-layer Pavement System ‚Äì Odemark Transformation Method**
"""
)

# ======================================================
# Sidebar : ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
# ======================================================
st.sidebar.header("‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á")

n_layer = st.sidebar.slider(
    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏",
    min_value=3,
    max_value=5,
    value=3
)

n_exp = st.sidebar.number_input(
    "‡∏Ñ‡πà‡∏≤ n (Odemark exponent)",
    min_value=1.0,
    max_value=5.0,
    value=3.0,
    step=0.1
)

st.sidebar.info("‡∏á‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß‡∏ó‡∏≤‡∏á‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ n ‚âà 3")

# ======================================================
# ‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏ (Default)
# ======================================================
default_layers = [
    "Wearing Course",
    "Base Course",
    "Subbase",
    "Subgrade",
    "Improved Subgrade"
]

layer_names = default_layers[:n_layer]

# ======================================================
# ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏™‡∏î‡∏∏
# ======================================================
st.subheader("üì• ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏")

cols = st.columns(n_layer)

h = []
E = []
names = []

for i in range(n_layer):
    with cols[i]:
        st.markdown(f"### ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà {i+1}")

        name = st.text_input(
            "‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏",
            value=layer_names[i]
        )

        h_i = st.number_input(
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ h (cm)",
            min_value=1.0,
            value=10.0,
            step=1.0
        )

        E_i = st.number_input(
            "Modulus E (MPa)",
            min_value=10.0,
            value=3000.0 if i == 0 else 300.0,
            step=50.0
        )

        names.append(name)
        h.append(h_i)
        E.append(E_i)

h = np.array(h)
E = np.array(E)

# ======================================================
# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (E_ref)
# ======================================================
st.divider()
st.subheader("üìå ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (Reference Layer)")

ref_layer_name = st.selectbox(
    "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô E_ref",
    options=names
)

ref_index = names.index(ref_layer_name)
E_ref = E[ref_index]

st.info(
    f"‡πÉ‡∏ä‡πâ **{ref_layer_name}** ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (E_ref = {E_ref:.0f} MPa)"
)

# ======================================================
# ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Equivalent Thickness
# ======================================================
odemark_factor = (E / E_ref) ** (1 / n_exp)
h_eq = np.sum(h * odemark_factor)

st.divider()
st.subheader("üìê ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")

st.metric(
    label="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ (h‚Çëq)",
    value=f"{h_eq:.2f} cm"
)

# ======================================================
# ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ
# ======================================================
df = pd.DataFrame({
    "‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà": np.arange(1, n_layer + 1),
    "‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏": names,
    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ h (cm)": h,
    "Modulus E (MPa)": E,
    "‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì Odemark": odemark_factor
})

st.subheader("üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏")
st.dataframe(df, use_container_width=True)

# ======================================================
# Sensitivity Analysis
# ======================================================
st.divider()
st.subheader("üìä Sensitivity Analysis")

delta = 0.10
h_eq_base = h_eq
sensitivity = []

for i in range(n_layer):
    E_new = E.copy()
    E_new[i] *= (1 + delta)

    h_eq_new = np.sum(
        h * (E_new / E_ref) ** (1 / n_exp)
    )

    S_i = ((h_eq_new - h_eq_base) / h_eq_base) / delta
    sensitivity.append(S_i)

df_sens = pd.DataFrame({
    "‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏": names,
    "Sensitivity": sensitivity
})

st.dataframe(df_sens, use_container_width=True)

# ======================================================
# ‡∏Å‡∏£‡∏≤‡∏ü (Cloud-safe)
# ======================================================
st.subheader("üìà ‡∏Å‡∏£‡∏≤‡∏ü Sensitivity ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô")

st.bar_chart(
    df_sens.set_index("‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏"),
    use_container_width=True
)

# ======================================================
# ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°
# ======================================================
critical_idx = df_sens["Sensitivity"].idxmax()

st.success(
    f"üìå **‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠ h‚Çëq ‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î:** "
    f"{df_sens.loc[critical_idx, '‡∏ä‡∏±‡πâ‡∏ô‡∏ß‡∏±‡∏™‡∏î‡∏∏']} "
    f"(Sensitivity = {df_sens.loc[critical_idx, 'Sensitivity']:.2f})"
)

st.markdown(
"""
### üß† ‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡πÄ‡∏ä‡∏¥‡∏á‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å **E_ref ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô ‚Üí h‚Çëq ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**
- ‡∏ä‡∏±‡πâ‡∏ô‡∏ö‡∏ô‡∏ó‡∏µ‡πà E ‡∏™‡∏π‡∏á‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏≠‡∏¥‡∏ó‡∏ò‡∏¥‡∏û‡∏•‡∏ï‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
- ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡πÉ‡∏ä‡πâ‡∏™‡∏≠‡∏ô:
  - ‡πÅ‡∏ô‡∏ß‡∏Ñ‡∏¥‡∏î Odemark
  - Sensitivity ‡∏Ç‡∏≠‡∏á Modulus
  - ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡πâ‡∏°‡∏Ñ‡πà‡∏≤
"""
)
