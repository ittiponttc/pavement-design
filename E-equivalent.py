import streamlit as st
import pandas as pd

# =============================
# ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà
# =============================
CM_TO_INCH = 1 / 2.54
MPA_TO_PSI = 145.038

# ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡πà‡∏≤ E ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (MPa)
E_LIMITS = {
    "‡πÅ‡∏≠‡∏™‡∏ü‡∏±‡∏•‡∏ï‡πå‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï (AC)": (1500, 5000),
    "‡∏ä‡∏±‡πâ‡∏ô‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏î‡πâ‡∏ß‡∏¢‡∏ã‡∏µ‡πÄ‡∏°‡∏ô‡∏ï‡πå (CTB)": (500, 5000),
    "‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏¥‡∏ô‡∏Ñ‡∏•‡∏∏‡∏Å / ‡∏ß‡∏±‡∏™‡∏î‡∏∏‡πÄ‡∏°‡πá‡∏î (Granular)": (100, 400),
    "‡∏ä‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏° (Subgrade)": (20, 150),
    "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ": (0, 10000)
}

# =============================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
# =============================
st.set_page_config(
    page_title="‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤",
    layout="centered"
)

st.title("‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á")
st.subheader("‡∏ß‡∏¥‡∏ò‡∏µ Odemark (1974)")
st.markdown("üëâ **‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ã‡∏ô‡∏ï‡∏¥‡πÄ‡∏°‡∏ï‡∏£ ‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô MPa**")

# =============================
# ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô
# =============================
n_layers = st.slider(
    "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á",
    min_value=1,
    max_value=5,
    value=3
)

layers = []

# =============================
# ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏±‡πâ‡∏ô
# =============================
st.markdown("### ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á")

for i in range(n_layers):
    with st.expander(f"‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà {i+1}", expanded=True):
        col1, col2, col3 = st.columns(3)

        with col1:
            material = st.selectbox(
                "‡∏ä‡∏ô‡∏¥‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏",
                list(E_LIMITS.keys()),
                key=f"mat_{i}"
            )

        with col2:
            thickness_cm = st.number_input(
                "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (‡∏ã‡∏°.)",
                min_value=0.1,
                value=10.0,
                step=0.5,
                key=f"h_{i}"
            )

        with col3:
            E_MPa = st.number_input(
                "‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏±‡∏™‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô E (MPa)",
                min_value=1.0,
                value=300.0,
                step=50.0,
                key=f"E_{i}"
            )

        # ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡πà‡∏≤ E ‡∏ú‡∏¥‡∏î‡∏ä‡πà‡∏ß‡∏á
        E_min, E_max = E_LIMITS[material]
        if not (E_min <= E_MPa <= E_max):
            st.warning(
                f"‡∏Ñ‡πà‡∏≤ E = {E_MPa:.0f} MPa ‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢ "
                f"({E_min} ‚Äì {E_max} MPa) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {material}"
            )

        layers.append({
            "‡∏ä‡∏±‡πâ‡∏ô": f"‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà {i+1}",
            "‡∏ä‡∏ô‡∏¥‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏": material,
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (‡∏ã‡∏°.)": thickness_cm,
            "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (‡∏ô‡∏¥‡πâ‡∏ß)": thickness_cm * CM_TO_INCH,
            "E (MPa)": E_MPa
        })

# =============================
# ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì
# =============================
if st.button("‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤"):

    sum_h = 0.0
    sum_h_E13 = 0.0

    for layer in layers:
        h = layer["‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (‡∏ã‡∏°.)"]
        E = layer["E (MPa)"]
        sum_h += h
        sum_h_E13 += h * (E ** (1/3))

    if sum_h == 0:
        st.error("‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏£‡∏ß‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0")
    else:
        Eeq_MPa = (sum_h_E13 / sum_h) ** 3
        Eeq_psi = Eeq_MPa * MPA_TO_PSI

        # =============================
        # ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        # =============================
        st.markdown("### ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å")
        df = pd.DataFrame(layers)
        st.dataframe(df, use_container_width=True)

        st.markdown("### ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì")
        st.success(
            f"**‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏±‡∏™‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤ (E_equivalent)** = "
            f"**{Eeq_psi:,.0f} psi** "
            f"**({Eeq_MPa:,.1f} MPa)**"
        )

        st.info(
            f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏≤‡∏á = "
            f"{sum_h:.2f} ‡∏ã‡∏°. ({sum_h * CM_TO_INCH:.2f} ‡∏ô‡∏¥‡πâ‡∏ß)"
        )
